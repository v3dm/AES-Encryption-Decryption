<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AES-Encryptor â€” Demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:40px auto; line-height:1.4; }
    textarea { width:100%; height:80px; }
    input[type="password"], input[type="text"] { width:100%; padding:8px; }
    button { padding:8px 12px; margin-top:8px; }
    .box { border:1px solid #ddd; padding:12px; margin-bottom:16px; border-radius:6px; }
    label { font-weight:600; display:block; margin-bottom:6px; }
    .small { font-size:0.9em; color:#555; }
  </style>
</head>
<body>
  <h2>AES-Encryptor â€” Basic Demo</h2>
  <p class="small">AES-256-GCM with PBKDF2 (password â†’ key). For demo only â€” do not use this exact code in production without review.</p>

  <div class="box">
    <label>Plaintext</label>
    <textarea id="plaintext" placeholder="Type text to encrypt...">Hello world</textarea>

    <label>Password</label>
    <input id="password" type="password" placeholder="Enter a password">

    <button onclick="doEncrypt()">Encrypt â†’ produce ciphertext</button>
    <p><label>Ciphertext (base64):</label><textarea id="ciphertext"></textarea></p>
  </div>

  <div class="box">
    <label>Ciphertext (base64)</label>
    <textarea id="ciphertext_in" placeholder="Paste ciphertext here..."></textarea>

    <label>Password</label>
    <input id="password_in" type="password" placeholder="Enter the same password">

    <button onclick="doDecrypt()">Decrypt â†’ recover plaintext</button>
    <p><label>Recovered plaintext:</label><textarea id="recovered"></textarea></p>
  </div>

  <script>
    function togglePassword(id, btn) {
  const input = document.getElementById(id);
  if (input.type === "password") {
    input.type = "text";
    btn.textContent = "ðŸ™ˆ"; // change icon to hide mode
  } else {
    input.type = "password";
    btn.textContent = "ðŸ‘ï¸"; // change icon back
  }
}

    async function doEncrypt() {
  const plaintext = document.getElementById('plaintext').value;
  const password = document.getElementById('password').value;
  if (!password) { alert("Enter a password"); return; }

  const resp = await fetch('/api/encrypt', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ plaintext, password })
  });
  if (!resp.ok) {
    alert('Encryption failed: ' + (await resp.text()));
    return;
  }
  const data = await resp.json();
  const ciphertext_b64 = data.ciphertext_b64;

  // update UI
  document.getElementById('ciphertext').value = ciphertext_b64;
  document.getElementById('ciphertext_in').value = ciphertext_b64; // helpful copy

  // --- auto-save to DB (only ciphertext, no password) ---
  // Read optional filename/note inputs if they exist in your HTML
  const filenameEl = document.getElementById('filenameInput');
  const noteEl = document.getElementById('noteInput');
  const filename = filenameEl ? filenameEl.value || null : null;
  const note = noteEl ? noteEl.value || "auto-saved" : "auto-saved";

  // If you want an opt-out checkbox, it will be checked below (see optional HTML)
  const autoSaveEnabled = (document.getElementById('autoSaveToggle')?.checked ?? true);

  if (autoSaveEnabled) {
    saveCiphertext(ciphertext_b64, filename, note).then(res => {
      if (res) {
        // optional: show saved id somewhere
        console.log("Saved record id:", res.id);
      }
    });
  }
}


    async function doDecrypt() {
      const ciphertext_b64 = document.getElementById('ciphertext_in').value;
      const password = document.getElementById('password_in').value;
      if (!ciphertext_b64 || !password) { alert("Provide ciphertext and password"); return; }

      const resp = await fetch('/api/decrypt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ ciphertext_b64, password })
      });
      if (!resp.ok) {
        const j = await resp.json().catch(()=>null);
        alert('Decryption failed: ' + (j?.detail || await resp.text()));
        return;
      }
      const data = await resp.json();
      document.getElementById('recovered').value = data.plaintext;
    }

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  const baseURL = "https://aes-encryption-decryption-sysz.onrender.com"; // <-- your Render URL

async function saveCiphertext(ciphertext_b64, filename = null, note = null) {
  try {
    const body = {
      ciphertext_b64,
      filename,
      note
    };

    const resp = await fetch(baseURL + "/api/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
      credentials: "omit"
    });

    if (!resp.ok) {
      const txt = await resp.text();
      console.error("Save failed:", resp.status, txt);
      showSaveStatus(false, `Save failed: ${resp.status}`);
      return null;
    }

    const data = await resp.json();
    console.log("Saved record:", data);
    showSaveStatus(true, `Saved (id: ${data.id})`);
    return data;
  } catch (err) {
    console.error("Save error:", err);
    showSaveStatus(false, "Save error (see console)");
    return null;
  }
}

function showSaveStatus(ok, msg) {
  let el = document.getElementById("saveStatus");
  if (!el) {
    el = document.createElement("div");
    el.id = "saveStatus";
    el.style.position = "fixed";
    el.style.right = "16px";
    el.style.bottom = "16px";
    el.style.padding = "8px 12px";
    el.style.borderRadius = "8px";
    el.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
    el.style.zIndex = 9999;
    el.style.fontFamily = "sans-serif";
    el.style.fontSize = "13px";
    document.body.appendChild(el);
  }
  el.style.background = ok ? "rgba(22,160,133,0.95)" : "rgba(192,57,43,0.95)";
  el.style.color = "#fff";
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(()=> { el.style.display = "none"; }, 4000);
}
    
  </script>
</body>
</html>
